{% load i18n email_obfuscator %}
{% load humanize %}
{% load static %}
<!DOCTYPE html>
<html lang="en">

  <head>
    {% include 'shared/head.html' %}
    {% include 'shared/cards_pic.html' %}
    <link rel="stylesheet" href={% static "v2/css/dashboard.css" %}>
    <link rel="stylesheet" href={% static "v2/css/profile.css" %}>
    <link rel="stylesheet" href={% static "v2/css/tag.css" %}>
  </head>

  <body class="interior {{active}}">
    {% include 'shared/tag_manager_2.html' %}
    <div class="container-fluid header profile-header dash">
      {% include 'shared/nav.html' %}
      <div class="container">
        <div class="row">
          <div class="col-12 col-lg-6">
            <div class="clearfix">
              <img class="profile-header__avatar mr-4" src="{{profile.avatar_url}}">
              <span class="profile-header__handle">
                {{profile.data.name}}<br>
                <small>{{profile.handle}}</small>
              </span>
            </div>
            {% if profile.data.bio %}
              <div class="profile-header__bio my-4">
                {{profile.data.bio}}
              </div>
            {% endif %}

            <ul class="profile-header__links clearfix my-4">
              <li>
                <a href="{{profile.data.blog}}">
                  <img src="{% static "v2/images/social/web.png" %}">{{profile.data.blog}}
                </a>
              </li>
              {% if profile.data.email and user.is_authenticated %}
                <li>
                  <a href="mailto:{{profile.data.email | obfuscate}}">
                    <img src="{% static "v2/images/social/mail.png" %}" alt="Medium">{{profile.data.email | obfuscate}}
                  </a>
                </li>
              {% endif %}
              <li>
                <a href="{{profile.data.html_url}}?tab=repositories">
                  <img src="{% static "v2/images/social/github.png" %}" alt="Medium">{{profile.data.login}}
                </a>
              </li>
            </ul>
          </div>
          <div class="col-12 col-lg-3">
            <div class="profile-header__stats profile-header__stats--contributor card mb-4">
              <div class="card-header">
                Contributor
              </div>
              <div class="card-body">
                <ul>
                  <li><span class="highlight">{{count_bounties_completed}}</span> bounties completed</li>
                  <li><span class="highlight">{{sum_eth_collected}}</span> ETH collected</li>
                  <li><span class="highlight">{{scoreboard_position_contributor}}</span> contributor</li>
                </ul>
              </div>
            </div>
          </div>
          <div class="col-12 col-lg-3">
            <div class="profile-header__stats profile-header__stats--funder card mb-4">
              <div class="card-header">
                Funder
              </div>
              <div class="card-body">
                <ul>
                  <li><span class="highlight">{{stats.1.0}}</span> bounties funded</li>
                  <li><span class="highlight">{{sum_eth_funded}}</span> ETH funded</li>
                  <li><span class="highlight">{{scoreboard_position_funder}}</span> funder</li>
                </ul>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="container">
      <div class="row">
        <div class="col py-4">Bounties in progress</div>
      </div>
      <div class="row">
        <div class="container profile-bounties profile-bounties--in-progress profile-bounties--loading">
          <button type="button" class="profile-bounties__btn-show-all btn btn-outline-secondary btn-block mt-1 py-2 hidden">Show all</button>
        </div>
      </div>

      <div class="row">
        <div class="col py-4">Bounties funded</div>
      </div>
      <div class="row">
        <div class="container profile-bounties profile-bounties--funded profile-bounties--loading">
          <button type="button" class="profile-bounties__btn-show-all btn btn-outline-secondary btn-block mt-1 py-2 hidden">Show all</button>
        </div>
      </div>

      <div class="row">
        <div class="col py-4">Bounties completed</div>
      </div>
      <div class="row">
        <div class="container profile-bounties profile-bounties--completed profile-bounties--loading">
          <button type="button" class="profile-bounties__btn-show-all btn btn-outline-secondary btn-block mt-1 py-2 hidden">Show all</button>
        </div>
      </div>
    </div>

    {% include 'shared/result.html' %}

    {% include 'shared/bottom_notification.html' %}
    {% include 'shared/analytics.html' %}
    {% include 'shared/footer_scripts.html'%}
    {% include 'shared/rollbar.html' %}
    {% include 'shared/footer.html' %}
    {% include 'shared/messages.html' %}

  </body>
  <!-- jQuery -->
  <script src="{% static "v2/js/abi.js" %}"></script>
  <script src="{% static "v2/js/tokens.js" %}"></script>
  <script src="{% static "v2/js/pages/profile_details.js" %}"></script>
  <script src="{% static "v2/js/shared.js" %}"></script>

  <script type="text/javascript">
    function renderBountyRowsFromResults(results) {
      var html = '';
      var tmpl = $.templates('#result');

      if (results.length == 0) {
        return '<p class="text-muted"><small>No resultsâ€¦</small></p>';
      }

      // Reused code from explorer/dashboard. Should be moved to some shared js.
      for (var i = 0; i < results.length; i++) {
          // setup
          var result = results[i];
          var related_token_details = tokenAddressToDetails(result['token_address']);
          var decimals = 18;

          if (related_token_details && related_token_details.decimals) {
            decimals = related_token_details.decimals;
          }

          var divisor = Math.pow(10, decimals);

          result['rounded_amount'] = Math.round(result['value_in_token'] / divisor * 100) / 100;
          var is_expired = new Date(result['expires_date']) < new Date() && !result['is_open'];

          result['action'] = result['url'];
          result['title'] = result['title'] ? result['title'] : result['github_url'];

          var timeLeft = timeDifference(new Date(result['expires_date']), new Date(), true);

          result['p'] = ((result['experience_level'] ? result['experience_level'] : 'Unknown Experience Level') + ' &bull; ');

          if (result['status'] === 'done')
            result['p'] += 'Done';
          if (result['fulfillment_accepted_on']) {
            result['p'] += ' ' + timeDifference(new Date(), new Date(result['fulfillment_accepted_on']), false, 60 * 60);
          } else if (result['status'] === 'started') {
            result['p'] += 'Started';
            result['p'] += ' ' + timeDifference(new Date(), new Date(result['fulfillment_started_on']), false, 60 * 60);
          } else if (result['status'] === 'submitted') {
            result['p'] += 'Submitted';
            if (result['fulfillment_submitted_on']) {
              result['p'] += ' ' + timeDifference(new Date(), new Date(result['fulfillment_submitted_on']), false, 60 * 60);
            }
          } else if (result['status'] == 'cancelled') {
            result['p'] += 'Cancelled';
            if (result['canceled_on']) {
              result['p'] += ' ' + timeDifference(new Date(), new Date(result['canceled_on']), false, 60 * 60);
            }
          } else if (is_expired) {
            var time_ago = timeDifference(new Date(), new Date(result['expires_date']), true);

            result['p'] += ('Expired ' + time_ago + ' ago');
          } else {
            var opened_when = timeDifference(new Date(), new Date(result['web3_created']), true);

            result['p'] += ('Opened ' + opened_when + ' ago, Expires in ' + timeLeft);
          }

          result['hidden'] = (i > 4) ? true : false;

          html += tmpl.render(result);
        }

        return html;
    }

    function fetchBountiesAndAddToList(params, target) {
      $.get('/api/v0.1/bounties/?' + params, function(results) {
        results = sanitizeAPIResults(results);

        var html = renderBountyRowsFromResults(results);
        $(target).prepend(html);
        $(target).removeClass('profile-bounties--loading');

        if (results.length > 5) {
          var $button = $(target + ' .profile-bounties__btn-show-all');
          $button.removeClass('hidden');
          $button.on('click', function(event) {
            $(this).remove();
            $(target + ' .bounty_row').removeClass('bounty_row--hidden');
          });
        }

        // Reused code from explorer/dashboard. Should be moved to some shared js.
        $('div.bounty_row.result').each(function() {
          var href = $(this).attr('href');

          if (typeof $(this).changeElementType !== 'undefined') {
            $(this).changeElementType('a'); // hack so that users can right click on the element
          }

          $(this).attr('href', href);
        });
      });
    }

    $(document).ready(function() {
      // TODO: Fix API call for bounties "in progress"
      fetchBountiesAndAddToList('bounty_owner_github_username={{profile.handle}}&is_open=true', '.profile-bounties--in-progress');

      // Fetch bounties user is owner
      fetchBountiesAndAddToList('bounty_owner_github_username={{profile.handle}}', '.profile-bounties--funded');

      // Fetch bounties user is fulfiller
      fetchBountiesAndAddToList('fulfiller_github_username={{profile.handle}}', '.profile-bounties--completed');
    });
  </script>
</html>
